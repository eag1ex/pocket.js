<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PocketExtended.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Pocket.html">Pocket</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketArchitect.html">PocketArchitect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketArchitect.html#architect">architect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketArchitect.html#.PocketSelectors#$architect">PocketSelectors#$architect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketArchitect.html#.PocketSelectors#$asset">PocketSelectors#$asset</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketLibs.html">PocketLibs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#accessLastValidTransfer">accessLastValidTransfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#clearStoreTransfers">clearStoreTransfers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#dataPropSelector">dataPropSelector</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#lastProbeID">lastProbeID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#lastProjectID">lastProjectID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#projectProbeList">projectProbeList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#projectSetDispatcher">projectSetDispatcher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#selectByTask">selectByTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketLibs.html#storeTransfers">storeTransfers</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketModule.html">PocketModule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#$activeTasks">$activeTasks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#$projectSetAsync">$projectSetAsync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#_emit">_emit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#_get">_get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#_setUpdate">_setUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#distributor">distributor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#payload">payload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#ready">ready</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#setDefer">setDefer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModule.html#setProbe">setProbe</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketModuleExt.html">PocketModuleExt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#$payload">$payload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#$removeProject">$removeProject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#deletePocketSet">deletePocketSet</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="global.html#PocketSelectors">PocketSelectors</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$all">$all</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$cached">$cached</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$campaign">$campaign</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$compute">$compute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$condition">$condition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$data">$data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$error">$error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$exists">$exists</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$filter">$filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$get">$get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$getByRef">$getByRef</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$list">$list</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$of">$of</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$onChange">$onChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$onProbeComplete">$onProbeComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$probe">$probe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$probeStatusAsync">$probeStatusAsync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$projectComplete">$projectComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$projectSet">$projectSet</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$ref">$ref</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$select">$select</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$set">$set</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$status">$status</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$task">$task</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$to">$to</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$transfer">$transfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PocketSelectors#$update">$update</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-d.html">d</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">PocketExtended.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// providing jsdocs intellisense
// eslint-disable-next-line no-unused-vars
const ProbeModel = require("../Probe/Probe")

// eslint-disable-next-line no-unused-vars
const ProjectPayloadModel = require("../Models/ProjectPayloadModel")

// @ts-ignore
const { onerror, warn, isPromise, validID, isString } = require("x-utils-es/umd")
// const sq = require('simple-q') // nice and simple promise/defer by `eaglex.net`
// const PocketLibs = require('./Pocket.libs')
const PocketModule = require("./Pocket.module")

/**
 * @class
 */
class PocketModuleExt extends PocketModule {
    constructor(opts, debug) {
        super(opts, debug)

        /**
         * @borrows $payload
         * @function $payload an alias on $payload(...)
         */
        this.$project = this.$payload
    }

    /**
     * - delete completed `pocketSet`
     */
    deletePocketSet(id) {
        if (!id) return
        if (Object.values(this.pocket).length) {
            for (let poc of Object.values(this.pocket)) {
                if (this._$cached_data[poc.id]) delete this._$cached_data[poc.id]
                if (poc.id.includes(id)) delete this.pocket[poc.id]
            }
        }
        if (this.payloadData[id]) delete this.payloadData[id]
        if (this._ready[id]) delete this._ready[id]

        // these  two are together
        if (this._projectSetDispatcher[id] !== undefined) delete this._projectSetDispatcher[id]
        if (this._projectSetAsync[id]) delete this._projectSetAsync[id]
        if (this._lastFilterList[id]) delete this._lastFilterList[id]

        // from PocketArchitect dynamicly assigned
        try {
            // @ts-ignore
            if (this.architectConfig[id]) delete this.architectConfig[id]
        } catch (err) {
            // blah
        }

        // empty self
        this.clearStoreTransfers(id)
    }
    /**
     * ### $removeProject
     * - removes all Probes and references relating to `projectID`
     * @param {*} projectID
     */
    $removeProject(projectID) {
        projectID = !isString(projectID) ? "" : projectID
        projectID = this.lastProjectID(projectID) // also updates last selector reference
        this.deletePocketSet(projectID)
        return this
    }

    /**
     * - you can also use it on concurrent payloads to existing `projectID`, once initial project is created every other call will update each Probe{}.data/status, based on payloadData
     * @param {ProjectPayloadModel | Promise&lt;ProjectPayloadModel>} data required
     * @param {*} async `override current opts.sync for this payload`
     * @param {"new"| "update"} type optional, new/update, `update`: if we call on an existing project we can update `data/status properties` of all assigned tasks at once
     * 
     * - `initialize new payload, for as many tasks`
     * - `sets a multi task with instructions:`
     * - `data = {
            id: '', // 1 id for all tasks
            tasks: [{ taskName: '', data: '', campaign: '' }]
        }`

    * - `call distributor and setDefer`
    * 
    */
    $payload(data, async, type) {
        const returnAs = (val) => {
            this.d = val
            return this
        }
        const asAsync = async !== undefined ? async : this.async // override if set
        if (asAsync &amp;&amp; isPromise(data)) {
            return returnAs(
                // @ts-ignore
                data.then(
                    (z) => this.payload(z, false, type),
                    (err) => err
                )
            )
        }
        // @ts-ignore
        if (!asAsync &amp;&amp; !isPromise(data)) return returnAs(this.payload(data, false, type))
        else {
            if (this.debug) onerror("[pocket]", `[payload] with opts.async=true, data must be a promise, or do not set async when not a promise`)
            if (asAsync) return returnAs(Promise.reject())
            else return returnAs(false)
        }
    }

    /**
     * @exports d
     * @memberof PocketModule
     * - resolves currently active `$payload(...)`
     * - `after completion of Pocket, instance data for all Probes is deleted`
     * - can be called even before project was declared thanks to callback dispatcher `$projectSetAsync()`
     * @param {*} payloadID ,required
     * @param { boolean?}  allowsMultiple optional, when set to true will allow multiple calls to resolved data
     * @param { boolean?} strict if true will check {payloadID} exists
     * @returns {PocketModule | {d:Promise&lt;any>}}
     */
    $ready(payloadID, allowsMultiple = false, strict = false) {
        try {
            /**
             *
             * @param {Promise&lt;ProbeModel[]>} val
             */
            const returnAs = (val) => {
                this.d = val
                if (this.d &amp;&amp; !allowsMultiple) {
                    this.d.catch((err) => {
                        if (!this.disableWarnings) warn("[pocket]", err)
                    })
                }
                return this
            }

            // soft validation for non existent `payloadID` if called before declaration of a project
            let _payloadID = this.lastProjectID(payloadID, null, strict === true ? "strict" : null)
            if (!payloadID &amp;&amp; _payloadID) payloadID = _payloadID // grab last assigned id incase provided none

            // in case it was called the second time, when already resolved!
            if (this.projectsCache[payloadID] === "complete" &amp;&amp; !allowsMultiple) {
                return returnAs(Promise.reject(`[$ready] project: ${payloadID} already complete`))
            }

            if (this._ready_method_set[payloadID] !== undefined &amp;&amp; !allowsMultiple) {
                if (this._ready_method_set[payloadID] === true) {
                    return returnAs(Promise.reject(`[$ready] project: ${payloadID} already complete, cannot recall same $ready, ALLOW_MULTIPLE_FALSE`))
                }

                if (this._ready_method_set[payloadID] === false) {
                    return returnAs(Promise.reject(`[$ready] project: ${payloadID} you already declared $ready somewhere else, this call is ignored, ALLOW_MULTIPLE_FALSE`))
                }
            }

            if (!_payloadID) {
                return returnAs(Promise.reject(`payloadID must be set`))
            }
            // we wrap it if on ready project so it allows declaring `${$ready()}` even before $project was created, cool ha!
            const p = this.$projectSetAsync(_payloadID).then(({ projectID }) => {
                return this.ready(projectID).then((z) => {
                    // NOTE to help problems with loops and using chaining with last selector
                    // will gradually delete project with specified timeout
                    if (!this.deleteWithDelay) this.deletePocketSet(projectID)
                    else {
                        setTimeout(() => {
                            this.deletePocketSet(projectID)
                        }, this.deleteWithDelay)
                    }

                    this.projectsCache[projectID] = "complete"
                    this._ready_method_set[_payloadID] = true
                    return z
                }, Promise.reject)
            }, Promise.reject)

            this._ready_method_set[_payloadID] = false
            return returnAs(p)
        } catch (error) {
            if (!this.disableWarnings) onerror("[pocket]", error)
        }
    }
}

module.exports = PocketModuleExt
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Tue Feb 06 2024 18:01:04 GMT+0700 (Indochina Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
