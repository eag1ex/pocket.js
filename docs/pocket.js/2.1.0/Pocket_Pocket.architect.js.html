<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pocket/Pocket.architect.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketArchitect.html">PocketArchitect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketArchitect.html#architect">architect</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketModuleExt.html">PocketModuleExt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#$payload">$payload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#$removeProject">$removeProject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketModuleExt.html#deletePocketSet">deletePocketSet</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="PocketSelectors.html">PocketSelectors</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$all">$all</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$architect">$architect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$asset">$asset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$cached">$cached</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$campaign">$campaign</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$compute">$compute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$condition">$condition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$data">$data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$error">$error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$exists">$exists</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$filter">$filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$get">$get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$getByRef">$getByRef</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$list">$list</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$of">$of</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$onChange">$onChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$onProbeComplete">$onProbeComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$probe">$probe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$probeStatusAsync">$probeStatusAsync</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$projectComplete">$projectComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$projectSet">$projectSet</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$ref">$ref</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$select">$select</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$set">$set</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$status">$status</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$task">$task</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$to">$to</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$transfer">$transfer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="PocketSelectors.html#$update">$update</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Probe.html">Probe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#all">all</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#dispatchChange">dispatchChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#onChange">onChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#onComplete">onComplete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#onOpenStatus">onOpenStatus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Probe.html#update">update</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-d.html">d</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Pocket/Pocket.architect.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ### Architect
 * a more in depth project architecture setup, allowing more robust configuration, manipulation and data flows
 */

const { validProjectID } = require("../utils")

const { objectSize, isFunction, onerror, warn, isString } = require("x-utils-es/umd")
const ArchitectModel = require("../Models/ArchitectModel")
const PocketModuleExt = require("./PocketExtended")

/**
 * @class
 */
class PocketArchitect extends PocketModuleExt {
    constructor(opts, debug) {
        super(opts, debug)

        this.architectConfig = {}
        const archModel = new ArchitectModel()
        this.architectMod = archModel.architect
    }

    setArchitect(projectID, val) {
        if (this.architectConfig[projectID] === undefined) this.architectConfig[projectID] = this.architectMod
        this.architectConfig[projectID]["value"] = Object.assign({}, this.architectConfig[projectID]["value"], val)
        return this
    }

    getArchitect(projectID) {
        return (this.architectConfig[projectID] || {})["value"]
    }

    /**
     * @ignore
     * @param assetName string, specify the name you chose in your `$architect(...)` declaration,
     * @param {Function} asCallback when exists, return asset as callback
     * @param projectID optional, update selector and return desired asset
     * @returns {object | null} if callback is returned the same value is returned
     */
    asset(assetName, asCallback, projectID) {
        if (!isFunction(asCallback)) {
            if (this.debug) warn("[pocket]", `[$asset] asCallback must be a function`)
            return null
        }
        // reserved names
        if (assetName === "project" || assetName === "cache") {
            if (this.debug) warn("[pocket]", `[$asset] 'project, cache' are  restricted`)
            return undefined
        }
        const lastProject = this.lastProjectID(projectID) // in case we are calling `$architect` on existing project
        projectID = validProjectID(lastProject || projectID)

        if (this.getArchitect(projectID)) {
            if (this.getArchitect(projectID)[assetName] !== undefined) {
                return asCallback.call(this, this.getArchitect(projectID)[assetName])
            } else {
                if (this.debug) warn("[pocket]", `[$asset] assetName for architect doesnt exist`)
                return null
            }
        } else {
            if (this.debug) warn("[pocket]", `[$asset] architectConfig for assetName doesnt exist`)
            return null
        }
    }

    /**
     * - can be used as a project setter same as `$payload` or `$project`, but with additional configuration
     *
     * @param {Function} cb required, must return project settings: `{project:{payloadData}, asset:{value, name}, cache:{project, asset}}
     * @param projectID optional
     * @returns {this}
     */
    architect(cb, projectID) {
        if (!isFunction(cb)) {
            if (this.debug) onerror("[pocket]", `[$architect] callback must be set`)
            return this
        }

        const config = cb.call(this /** ,?? */)

        if (!objectSize(config)) {
            if (this.debug) onerror("[pocket]", `[architect] must return a valid object settings {project, asset}, at least 1 is required`)
            return this
        }

        const configProjectID = (config["project"] || {}).id
        const lastProject = this.lastProjectID(projectID) // in case we are calling `$architect` on existing project
        projectID = validProjectID(lastProject || projectID || configProjectID)

        if (!projectID) {
            if (this.debug) onerror("[pocket]", `[$architect] if this is a new project, you must specify projectID`)
            return this
        }
        const validConfig = Object.entries(config).reduce((n, [k, value]) => {
            if (["project", "asset", "cache"].indexOf(k) !== -1) n[k] = value
            return n
        }, {})

        // default setting for `architect.cache` if getArchitect not stored
        if (!(this.getArchitect(projectID) || {})["cache"]) {
            const defaults = { project: false, asset: false }
            if (!validConfig["cache"]) validConfig["cache"] = defaults

            this.setArchitect(projectID, {
                cache: validConfig["cache"]
            })
        } else validConfig["cache"] = this.getArchitect(projectID)["cache"]

        for (let k in validConfig) {
            const item = validConfig[k]
            // get last cache override
            const cached = validConfig["cache"][k] === true &amp;&amp; (k === "project" || k === "asset")

            if (k === "project") {
                // item['async'] item['type'] .. can include `async` and `type`
                try {
                    if (cached &amp;&amp; this.getArchitect(projectID)[k]) continue
                } catch (err) {
                    //
                }

                this.setArchitect(projectID, { project: this.$payload(item, item["async"], item["type"]).d })
            }

            if (k === "asset") {
                if (!isString(item["name"]) || item["value"] === undefined) {
                    if (this.debug) warn("[pocket]", `[$architect] asset must include {value, name}`)
                    return this
                }
                if (item["name"] === "project" || item["name"] === "cache") {
                    if (this.debug) warn("[pocket]", `[$architect] asset props, "project, cache" are reserved`)
                    return this
                }
                try {
                    if (cached &amp;&amp; this.getArchitect(projectID)[item["name"]]) continue
                } catch (err) {
                    //
                }

                // if already exists, same assets will be overridden and new will be created
                this.setArchitect(projectID, {
                    [item["name"]]: item["value"]
                })
            }
        }
        return this
    }
}

module.exports = PocketArchitect
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Tue Feb 06 2024 18:11:40 GMT+0700 (Indochina Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
